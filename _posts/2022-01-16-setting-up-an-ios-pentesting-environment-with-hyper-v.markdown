---
layout: post
title:  "Setting Up an iOS Pentesting Environment with Hyper-V"
date:   2022-01-16 01:00:00 +0900
category: Mobile Security
---

* content
{:toc}

Hyper-V 게스트에서 원격 iOS 디바이스에 Frida를 사용할 수 있는 방법을 설명한다.

원래는 Hyper-V의 USB 디바이스 공유를 이용하여 게스트에서 iOS 디바이스 점검을 진행하려 했지만, Frida에서 USB를 통한 연결이 이루어지지 않았고 대신 SSH 포트 포워딩을 통해 연결할 수 있었다.

## Prerequisite

Hyper-V 게스트의 네트워크 어댑터는 별도의 변경 없이 `Default Switch`로 설정하였으며, iOS 디바이스는 Hyper-V 호스트와 동일한 네트워크에 연결된 상태로 진행한다.

- Hyper-V Guest OS (Windows)
- iOS Device (Jailbroken)

## Installation

### Install Frida and objection

Hyper-V 게스트에서 frida와 objection을 설치한다.

```
PS> pip install frida-tools
PS> pip install objection
```

## SSH Local Port Forwarding

Hyper-V 게스트에서 원격 iOS 디바이스의 `frida-server`에 연결하기 위해 SSH Local Port Forwarding을 사용한다. `frida-server`는 기본적으로 27042번 포트를 사용한다.

SSH 연결이 수립된 후 `frida-server`에 연결하기 위해 해당 터미널을 종료하지 않고 계속 연결을 유지시킨다.

```
PS> ssh -L 27042:127.0.0.1:27042 root@{Remote-iOS-ip}
...
Your-iPhone:~ root#
```

## Connect Frida to an iOS Device

Hyper-V 게스트에서 `frida-ps` 명령을 통해 원격 iOS 디바이스에 연결이 되는 것을 확인 할 수 있다. 

```
PS> frida-ps -R | Select-String Cydia

1577  Cydia
```

Frida 사용 시 `-R`, `--remote` 옵션을 통해 원격 연결로 지정하여 사용해야 한다.

```
PS> frida --help
Usage: frida [options] target

Options:
  --version             show program's version number and exit
  -h, --help            show this help message and exit
  -D ID, --device=ID    connect to device with the given ID
  -U, --usb             connect to USB device
  -R, --remote          connect to remote frida-server
  -H HOST, --host=HOST  connect to remote frida-server on HOST
```

objection 사용 시 `-N`, `--network` 옵션을 통해 원격 연결로 지정하여 사용해야 한다.

```
PS> objection --network -g DVIA-v2 explore
Using networked device @`127.0.0.1:27042`
Agent injected and responds ok!

     _   _         _   _
 ___| |_|_|___ ___| |_|_|___ ___
| . | . | | -_|  _|  _| | . |   |
|___|___| |___|___|_| |_|___|_|_|
      |___|(object)inject(ion) v1.11.0

     Runtime Mobile Exploration
        by: @leonjza from @sensepost

[tab] for command suggestions
....highaltitudehacks.DVIAswiftv2 on (iPhone: 14.6) [net] #
```

## References

[unable to connect to remote frida-server - GitHub](https://github.com/frida/frida/issues/582){:target="_blank"}

[(Objection) Mobile apps on remote device - ub3rsick.github.io](https://ub3rsick.github.io/2018/09/21/objection-remote-device-app-hook/){:target="_blank"}

[objection - Runtime Mobile Exploration - GitHub](https://github.com/sensepost/objection){:target="_blank"}

[How to Set up SSH Tunneling (Port Forwarding) - Linuxize](https://linuxize.com/post/how-to-setup-ssh-tunneling/){:target="_blank"}

[SSH port forwarding - Example, command, server config - SSH.COM](https://www.ssh.com/academy/ssh/tunneling/example){:target="_blank"}
